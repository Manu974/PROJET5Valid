<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <title>observation</title>
    <link rel="stylesheet" href="{{ asset('css/list.css') }}">
  </head>

  <body>
  <div id="map" ></div>
    <h3>Resultats de recherche</h3>
<div class="well">
    {{ form(form) }}
    </div>
	<table id="listObservation" style="width:50%">
		  <tr>
		  	<th>Status</th>
		    <th>N°</th>
		    <th>Dpt</th> 
		    <th>Famille</th>
		    <th>Nom de l'oiseau</th>
		    <th>Auteur</th>
		  </tr>
</table>

<div id="detailObs" class="well">
	<p id="NomOiseau"></p>
	<p id="Famille"></p>
	<p id="Nombre"></p>
	<p id="Situation"></p>
	<p id="Auteur"></p>
	<p id="Commentaire"></p>
  <div id="bouttonDetails"></div>
  
</div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script>
      $(function() {

       	$.ajax({
    		url:'http://127.0.0.1:8000/api/observations/lists', 
    		type : 'GET',
    		//timeout : 3000,
    		success: function(data){
    			$.each(data,function(i, observation){
            //console.log(observation);
    				var trUser = '<tr><td name="status" is_valid = '+observation.is_valid+' id="'+observation.id+'"></td><td>'+observation.id+'</td><td>'+observation.department+'</td><td>'+observation.famille+'</td><td>'+observation.nom_vernaculaire+'</td><td>'+observation.author+'</td><td><button name="validationObservation" type="button" id="'+observation.id+'">valider</button><button name="vueDetails" type="button" id="'+observation.id+'">Vue Detailee</button></td></tr>';
    				$('#listObservation').append(trUser);



            if(observation.is_valid==true){
              $('[is_valid$="true"]').css('background', 'green');
              $('[name$="validationObservation"]').attr("disabled",true);

            }

            if(observation.is_valid==false){
              $('[is_valid$="false"]').css('background', 'red');
              
            }


    			});
		    },
		    error: function(){
		      alert('La requête n\'a pas abouti');
		    }
		  });

       	$('table').on("click",'button[name="validationObservation"]', function(){
       		window.location.replace('http://localhost:8000/observation/validation/'+this.id);
       	});


       	$('table').on("click",'button[name="vueDetails"]', function(e){
          $('#bouttonDetails').empty();
         		$.ajax({
      		url:'http://127.0.0.1:8000/api/observations/'+this.id, 
      		type : 'GET',
      		success: function(data){
      
      				$('#NomOiseau').text(data.nom_vernaculaire);
      				$('#Famille').text(data.famille);
      				$('#Nombre').text(data.nombre_oiseaux);
      				$('#Situation').text(data.nidification);
      				$('#Auteur').text(data.author);
      				$('#Commentaire').text(data.comment);
              var buttonDetails = '<button type="button" id="detailsBloque">Bloquer auteur</button><button type="button" id="detailsDebloque">Débloquer auteur</button><button type="button" id="'+data.id+'" name="detailsSupprimer">Supprimer</button><button type="button" id="'+data.id+'" name="detailsValider">Valider</button>';
              $('#bouttonDetails').append(buttonDetails);

              if(data.is_valid==true){
                $('[name$="detailsValider"]').attr("disabled",true);
              }
             
  		    },
  		    error: function(){
  		      alert('La requête n\'a pas abouti');
  		    }
  		  });
      });

        $('#detailObs').on("click",'button[name="detailsSupprimer"]', function(){
          console.log(this.id);
          $.ajax({
          url:'http://127.0.0.1:8000/api/observations/delete/'+this.id, 
          type : 'DELETE',
          success: function(data){
            alert("observaiton supprimer");
            location.reload(true);
          },
          error: function(){
            alert('La requête n\'a pas abouti');
          }
        });
        });

        $('#detailObs').on("click",'button[name="detailsValider"]', function(){
         window.location.replace('http://localhost:8000/observation/validation/'+this.id);
        });

        var familleNames = {};
          var nomScientifiqueNames = {};
          var nomVernaculaireNames = {};

            $("select[name='observation_espace_pro[famille]'] > option").each(function () {
                if(familleNames[this.text]) {
                    $(this).remove();
                } else {
                    familleNames[this.text] = this.value;
                }
            });

            $("select[name='observation_espace_pro[nomScientifique]'] > option").each(function () {
                if(nomScientifiqueNames[this.text]) {
                    $(this).remove();
                } else {
                    nomScientifiqueNames[this.text] = this.value;
                }
            });

            $("select[name='observation_espace_pro[nomVernaculaire]'] > option").each(function () {
                if(nomVernaculaireNames[this.text]) {
                    $(this).remove();
                } else {
                    nomVernaculaireNames[this.text] = this.value;
                }
            });



      });
    </script>
    <script>
    

      function initMap() {
        var France = {lat: 46.227638, lng: 2.213749000000007};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: France
        });


/*
    var film = {
    
    famille: "Accipitridae",
    nom_vernaculaire: "Épervier bicolore",
    nom_scientifique: "Accipiter bicolor",
    department: 1,
    is_valid: true,
    author: "pop"
    
};
   
        /*var marker = new google.maps.Marker({
          position: France,
          map: map
        });*/
        //var infoWindow = new google.maps.InfoWindow({map: map});
        

        // Try HTML5 geolocation.
        /*if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found.');
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }*/
      }


      function ajaxPost(url, data, callback, isJson) {
    var req = new XMLHttpRequest();
    req.open("POST", url);
    req.addEventListener("load", function () {
        if (req.status >= 200 && req.status < 400) {
            // Appelle la fonction callback en lui passant la réponse de la requête
            callback(req.responseText);
        } else {
            console.error(req.status + " " + req.statusText + " " + url);
        }
    });
    req.addEventListener("error", function () {
        console.error("Erreur réseau avec l'URL " + url);
    });
    if (isJson) {
        // Définit le contenu de la requête comme étant du JSON
        req.setRequestHeader("Content-Type", "application/json");
        // Transforme la donnée du format JSON vers le format texte avant l'envoi
        data = JSON.stringify(data);
    }
    req.send(data);
}

var form = document.querySelector("form");

form.addEventListener("submit", function(e){
      e.preventDefault();
    
      var famille = document.getElementById("observation_espace_pro_famille").options[document.getElementById("observation_espace_pro_famille").selectedIndex].text;

      var nomVern = document.getElementById("observation_espace_pro_nomVernaculaire").options[document.getElementById("observation_espace_pro_nomVernaculaire").selectedIndex].text;
      var nomScien = document.getElementById("observation_espace_pro_nomScientifique").options[document.getElementById("observation_espace_pro_nomScientifique").selectedIndex].text;
      var departement = document.getElementById("observation_espace_pro_department").options[document.getElementById("observation_espace_pro_department").selectedIndex].text;
      var status =  document.getElementById("observation_espace_pro_isValid").value;
      var author = document.getElementById("observation_espace_pro_author").value;

      var ListObs = {
    
    "famille": famille,
    "nom_vernaculaire": nomVern,
    "nom_scientifique": nomScien,
    "department": departement,
    "is_valid": status,
    "author": author
};
  
 $.ajax({
                url:'http://localhost:8000/api/observations/lists/carte', 
                type : 'POST',
                data: JSON.stringify(ListObs),
                dataType: 'json',
                contentType: 'application/json',
                processData: false,
                success: function(data){
                console.log(data);
                },
                error: function(xhr, ajaxOptions, thrownError){
                  alert(xhr.status);
                  alert(thrownError);
                }
              });
});

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
      }
    </script>
    </script>
    <script type="text/javascript" async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyZgz9fFFmD4Vf_0nJTlde0VEq6KxhFrw&callback=initMap">
    </script>
    </body>
</html>